<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ralph Magazine Chatbot</title>
    <style>
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; height: 100vh; display: flex; }
      .sidebar { width: 280px; background: #0f172a; color: #e2e8f0; padding: 16px; }
      .sidebar h1 { font-size: 16px; margin: 0 0 12px; }
      .sidebar button, .sidebar a { display: block; width: 100%; margin: 8px 0; padding: 10px 12px; border: 0; border-radius: 8px; cursor: pointer; text-align: left; }
      .sidebar button { background: #1f2937; color: #e2e8f0; }
      .sidebar button:hover { background: #374151; }
      .main { flex: 1; display: flex; flex-direction: column; }
      .messages { flex: 1; overflow-y: auto; padding: 24px; background: #f8fafc; }
      .msg { max-width: 840px; margin: 0 auto 16px; padding: 16px; border-radius: 12px; }
      .msg.user { background: #e0e7ff; }
      .msg.assistant { background: #fff; border: 1px solid #e5e7eb; }
      .input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #e5e7eb; background: #fff; }
      .input textarea { flex: 1; resize: vertical; min-height: 52px; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #e5e7eb; }
      .input button { padding: 12px 16px; font-size: 16px; border: 0; border-radius: 8px; background: #0ea5e9; color: #fff; cursor: pointer; }
      .sources { max-width: 840px; margin: 16px auto; font-size: 14px; color: #334155; }
      .source-item { margin-bottom: 6px; }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h1>Ralph Chat</h1>
      <button id="btnSetAuth">Set Admin Auth</button>
      <div style="margin:8px 0; font-size:12px; color:#93c5fd">Admin: <span id="adminStatus">not set</span></div>
      <hr style="border:0;border-top:1px solid #334155;opacity:.4"/>
      <div style="margin:8px 0 6px; font-size:12px; opacity:.85">Step 1: Connect Google Drive</div>
      <a id="authLink" href="#" target="_blank">Open Google consent (Web)</a>
      <a id="authLinkInstalled" href="#" target="_blank" style="margin-top:6px">Open Google consent (Desktop/manual)</a>
      <input id="codeInput" placeholder="Paste authorization code" style="width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid #475569;background:#0b1220;color:#e2e8f0" />
      <button id="btnSubmitCode">Submit Code</button>
      <div style="margin:8px 0; font-size:12px; color:#93c5fd">Drive: <span id="driveStatus">not connected</span></div>
      <div style="margin:4px 0; font-size:12px; color:#93c5fd">Folders: <span id="folderStatus">0 configured</span></div>
      <hr style="border:0;border-top:1px solid #334155;opacity:.4"/>
      <div style="margin:8px 0 6px; font-size:12px; opacity:.85">Step 2: Sync</div>
      <button id="btnSync" disabled>Sync Google Drive</button>
      <small style="display:block;margin-top:8px;opacity:.7">Authorize once, submit the code, then sync.</small>
      <div style="margin-top:16px;font-size:12px;opacity:.8">Status: <span id="status">Idle</span></div>
    </div>
    <div class="main">
      <div id="messages" class="messages"></div>
      <div class="sources" id="sources"></div>
      <div class="input">
        <textarea id="input" placeholder="Ask about issues, quotes, authors, pages..."></textarea>
        <button id="send">Send</button>
      </div>
    </div>
    <script>
      const messagesEl = document.getElementById('messages');
      const sourcesEl = document.getElementById('sources');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const statusEl = document.getElementById('status');
      const authLink = document.getElementById('authLink');

      let adminAuth = localStorage.getItem('adminAuth') || '';
      function authHeaders() {
        return adminAuth ? { 'Authorization': 'Basic ' + adminAuth } : {};
      }

      async function initAuth() {
        try {
          const r = await fetch('/api/sync/auth-url', { headers: authHeaders() });
          const j = await r.json();
          authLink.href = j.url;
        } catch (e) { console.error(e); authLink.removeAttribute('href'); }
        try {
          const r2 = await fetch('/api/sync/auth-url?flow=installed', { headers: authHeaders() });
          const j2 = await r2.json();
          document.getElementById('authLinkInstalled').href = j2.url;
        } catch (e) { console.error(e); }
      }
      initAuth();

      async function refreshStatus() {
        const adminEl = document.getElementById('adminStatus');
        const driveEl = document.getElementById('driveStatus');
        const folderEl = document.getElementById('folderStatus');
        const syncBtn = document.getElementById('btnSync');
        try {
          const r = await fetch('/api/sync/status', { headers: authHeaders() });
          if (r.status === 401 || r.status === 503) {
            adminEl.textContent = 'not set';
            driveEl.textContent = 'unknown (set admin first)';
            folderEl.textContent = 'unknown';
            syncBtn.disabled = true;
            return;
          }
          const j = await r.json();
          adminEl.textContent = 'set';
          driveEl.textContent = j.hasToken ? 'connected' : 'not connected';
          folderEl.textContent = j.folderIds && j.folderIds.length ? `${j.folderIds.length} configured` : '0 configured';
          syncBtn.disabled = !j.canSync;
        } catch (e) {
          adminEl.textContent = 'error';
          syncBtn.disabled = true;
        }
      }
      refreshStatus();

      document.getElementById('btnSetAuth').onclick = async () => {
        const u = prompt('Admin username:');
        if (!u) return;
        const p = prompt('Admin password:');
        if (p == null) return;
        adminAuth = btoa(u + ':' + p);
        localStorage.setItem('adminAuth', adminAuth);
        await initAuth();
        await refreshStatus();
        statusEl.textContent = 'Admin auth set (saved locally)';
      };

      document.getElementById('btnSubmitCode').onclick = async () => {
        const code = document.getElementById('codeInput').value.trim();
        if (!code) return alert('Paste the authorization code first');
        statusEl.textContent = 'Submitting code...';
        try {
          const r = await fetch('/api/sync/oauth2/callback', { method:'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ code }) });
          const j = await r.json();
          if (!r.ok) throw new Error(j.error || 'Auth code failed');
          statusEl.textContent = 'Drive token saved';
          document.getElementById('codeInput').value='';
          await refreshStatus();
        } catch (e) {
          statusEl.textContent = 'Failed to save token';
          alert(e.message);
        }
      };

      document.getElementById('btnSync').onclick = async () => {
        statusEl.textContent = 'Syncing...';
        try {
          const r = await fetch('/api/sync/google-drive', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() } });
          const j = await r.json();
          if (!r.ok) throw new Error(j.error || 'Sync error');
          const skipped = j.files_skipped ? `, skipped ${j.files_skipped}` : '';
          statusEl.textContent = `Sync complete: processed ${j.files_processed}${skipped}`;
          await refreshStatus();
        } catch (e) {
          statusEl.textContent = 'Sync failed';
          alert(e.message);
        }
      };

      function addMessage(role, text) {
        const d = document.createElement('div');
        d.className = 'msg ' + role;
        d.textContent = text;
        messagesEl.appendChild(d);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return d;
      }

      sendBtn.onclick = async () => {
        const q = inputEl.value.trim();
        if (!q) return;
        inputEl.value = '';
        addMessage('user', q);
        const a = addMessage('assistant', '');
        sourcesEl.innerHTML = '';

        const r = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: q }) });
        if (!r.ok) {
          const j = await r.json().catch(() => ({}));
          a.textContent = j.error || 'Error';
          return;
        }
        const reader = r.body.getReader();
        const dec = new TextDecoder();
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = dec.decode(value);
          for (const line of chunk.split('\n')) {
            if (!line.startsWith('data: ')) continue;
            const evt = JSON.parse(line.slice(6));
            if (evt.type === 'text') {
              a.textContent += evt.delta;
            } else if (evt.type === 'sources') {
              sourcesEl.innerHTML = evt.sources.map(s => {
                const parts = [s.ref, s.title, s.author ? `by ${s.author}` : null, s.issue ? `Issue ${s.issue}` : null, s.page ? `p.${s.page}` : null].filter(Boolean).join(' Â· ');
                const link = s.url ? `<a href="${s.url}" target="_blank">Open</a>` : '';
                return `<div class="source-item">${parts} ${link}</div>`;
              }).join('');
            } else if (evt.type === 'error') {
              a.textContent = '[Error] ' + evt.error;
            }
          }
        }
      };
    </script>
  </body>
  </html>
